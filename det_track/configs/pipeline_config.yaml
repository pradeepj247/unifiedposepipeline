# Detection & Tracking Pipeline Configuration
# Multi-stage pipeline for person detection, tracking, and identity resolution

# ============================================================================
# Global Path Variables (Single Source of Truth)
# ============================================================================
global:
  # Repository root - change this for different environments
  repo_root: /content/unifiedposepipeline  # Colab
  # repo_root: D:/trials/unifiedpipeline/newrepo  # Windows (uncomment for local)
  
  # Derived paths (use ${variable} syntax)
  models_dir: ${repo_root}/models
  demo_data_dir: ${repo_root}/demo_data
  outputs_dir: ${demo_data_dir}/outputs
  
  # Video input settings - change video_file to process different videos
  video_dir: ${demo_data_dir}/videos/
  video_file: kohli_nets.mp4

# ============================================================================
# Pipeline Stage Control - SINGLE SOURCE OF TRUTH
# ============================================================================
# NOTE: These settings ALONE control which stages execute.
# Individual stage configs (e.g., stage6_create_output_video: enabled:) are
# IGNORED by run_pipeline.py and should NOT be used to enable/disable stages.
# Use ONLY the settings below to control pipeline execution.
# ============================================================================
pipeline:
  # Stage execution control - SIMPLE NUMERIC IDs 1-11 - the ONLY place to enable/disable stages
  stages:
    stage1: true                           # Stage 1: YOLO detection
    stage2: true                           # Stage 2: ByteTrack offline tracking
    stage3: true                           # Stage 3: Tracklet statistics & candidate analysis
    stage4: true                           # Stage 4: Load crops cache (lightweight)
    stage5: true                           # Stage 5: Group tracklets into canonical persons
    stage6: true                           # Stage 6: Enrich crops with person IDs and metadata (HDF5)
    stage7: true                           # Stage 7: Rank persons by appearance time
    stage8: false                          # Stage 8: Optional: Show grouping tables (debug)
    stage9: true                           # Stage 9: Create video visualization of top 10 persons
    stage10: true                          # Stage 10: Create HTML selection report
    stage11: true                          # Stage 11: Generate animated GIFs for top 10 persons
  
  # Global settings inherited by all stages (can be overridden per-stage if needed)
  advanced:
    verbose: false                         # Debug output for all stages (set true to see detailed logs)


# ============================================================================
# Stage 1: YOLO Detection
# ============================================================================
stage1:
  detector:
    model_path: ${models_dir}/yolo/yolov8s.pt  # Use .engine for TensorRT (requires tensorrt package)
    confidence: 0.3
    device: cuda
    detect_only_humans: true
  
  detection_limit:
    method: hybrid  # Options: top_n, confidence, hybrid
    max_count: 15   # Maximum detections per frame
    min_confidence: 0.3  # Minimum confidence threshold
  
  input:
    max_frames: 0  # 0 = all frames
  
  output:
    detections_file: ${outputs_dir}/${current_video}/detections_raw.npz
    crops_cache_file: ${outputs_dir}/${current_video}/crops_cache.pkl

# ============================================================================
# Stage 2: ByteTrack Offline Tracking
# ============================================================================
# NOTE: Only ByteTrack is currently supported (hardcoded in stage2_track.py)
stage2:
  params:
    track_thresh: 0.15     # Confidence threshold for tracking (lowered for better recall)
    track_buffer: 30       # Buffer size for lost tracks (frames)
    match_thresh: 0.8      # IOU threshold for matching
    min_hits: 1            # Minimum consecutive detections to create track (1=immediate)
  
  input:
    detections_file: ${outputs_dir}/${current_video}/detections_raw.npz
  
  output:
    tracklets_file: ${outputs_dir}/${current_video}/tracklets_raw.npz

# ============================================================================
# Stage 3: Tracklet Analysis
# ============================================================================
stage3:
  analysis:
    compute_statistics: true  # Temporal, spatial, motion stats
    identify_candidates: true # Find suspicious tracklet pairs for ReID
  
  candidate_criteria:
    max_temporal_gap: 50       # Frames between tracklet end/start
    max_spatial_distance: 300  # Pixels between last/first bbox centers
    area_ratio_range: [0.6, 1.4]  # Min/max area ratio for size consistency
  
  input:
    tracklets_file: ${outputs_dir}/${current_video}/tracklets_raw.npz
  
  output:
    tracklet_stats_file: ${outputs_dir}/${current_video}/tracklet_stats.npz
    candidates_file: ${outputs_dir}/${current_video}/reid_candidates.json

# ============================================================================
# Stage 4: Load Crops Cache (Lightweight - No ReID Recovery)
# ============================================================================
# NOTE: This is the lightweight version that loads pre-cached crops from Stage 1
# It does NOT perform ReID-based tracklet recovery
# For full ReID-based recovery, use the old stage4a_reid_recovery_onnx.py
stage4:
  input:
    crops_cache_file: ${outputs_dir}/${current_video}/crops_cache.pkl
  
  output:
    # No outputs - crops cache is loaded and passed to Stage 7

# ============================================================================
# Stage 5: Canonical Person Grouping
# ============================================================================
# To disable this stage, set pipeline.stages.stage5 to false
stage5:
  grouping:
    method: heuristic  # Options: heuristic, clustering, hybrid
    
    # Heuristic rules
    heuristic_criteria:
      max_temporal_gap: 30
      max_spatial_distance: 200
      area_ratio_range: [0.7, 1.3]
  
  input:
    # Auto-resolved based on stage4a.enabled
    recovered_tracklets_file: ${outputs_dir}/${current_video}/tracklets_recovered.npz
    tracklets_raw_file: ${outputs_dir}/${current_video}/tracklets_raw.npz
    tracklet_stats_file: ${outputs_dir}/${current_video}/tracklet_stats.npz
  
  output:
    canonical_persons_file: ${outputs_dir}/${current_video}/canonical_persons.npz
    grouping_log_file: ${outputs_dir}/${current_video}/grouping_log.json

# ============================================================================
# Stage 6: Enrich Crops with Person IDs and Metadata (HDF5)
# ============================================================================
# Creates crops_enriched.h5 with fast indexed lookups
# Input: canonical_persons.npz + crops_cache.pkl
# Output: crops_enriched.h5 with structure: person_ID -> frame_ID -> {image_bgr, bbox, width, height}
stage6:
  
  enrichment:
    format: hdf5              # Output format (HDF5 for fast indexed lookups)
    color_space: bgr          # Store BGR (native OpenCV format)
    compression: gzip         # HDF5 compression level (gzip)
  
  input:
    canonical_persons_file: ${outputs_dir}/${current_video}/canonical_persons.npz
    crops_cache_file: ${outputs_dir}/${current_video}/crops_cache.pkl
    detections_file: ${outputs_dir}/${current_video}/detections_raw.npz
  
  output:
    crops_enriched_file: ${outputs_dir}/${current_video}/crops_enriched.h5

# ============================================================================
# Stage 7: Rank Persons by Appearance Time
# ============================================================================
stage7:
  ranking:
    method: auto  # Options: auto (manual selection not yet implemented)
    
    # Auto-ranking weights
    weights:
      duration: 0.4       # Longest presence in video
      coverage: 0.3       # Percentage of frames covered
      center: 0.2         # Proximity to frame center
      smoothness: 0.1     # Motion stability (less jitter)
  
  input:
    canonical_persons_file: ${outputs_dir}/${current_video}/canonical_persons.npz
  
  output:
    primary_person_file: ${outputs_dir}/${current_video}/primary_person.npz
    ranking_report_file: ${outputs_dir}/${current_video}/ranking_report.json

# ============================================================================
# Stage 8: Visualize Grouping (Debug Only)
# ============================================================================
# To disable this stage, set pipeline.stages.stage8 to false
stage8:
  
  visualization:
    min_duration_seconds: 5    # Minimum appearance time to be included
    max_persons_shown: 10      # Show top 10 persons (or all if <10 qualify)
  
  input:
    canonical_persons_file: ${outputs_dir}/${current_video}/canonical_persons.npz
  
  output:
    video_file: ${outputs_dir}/${current_video}/top_persons_visualization.mp4

# ============================================================================
# Stage 10: HTML Selection Report
# ============================================================================
# To disable this stage, set pipeline.stages.stage10 to false
stage10:
  
  filters:
    min_duration_seconds: 5    # Minimum appearance time to be included
    max_persons_shown: 10      # Show top 10 persons (or all if <10 qualify)
  
  output:
    fullframe_grid: ${outputs_dir}/${current_video}/top10_persons_fullframe_grid.png
    cropped_grid: ${outputs_dir}/${current_video}/top10_persons_cropped_grid.png
    selection_info: ${outputs_dir}/${current_video}/selection_grid_info.json

# ============================================================================
# Stage 11: Generate Person MP4 Videos
# ============================================================================
# To disable this stage, set pipeline.stages.stage11 to false
stage11:
  
  video_generation:
    format: mp4              # Output format (mp4 for faster encoding & smaller file size)
    codec: mp4v              # MPEG-4 video codec (widely supported)
    fps: 15                  # Frames per second (15 fps = smooth playback at ~3.3 seconds)
    max_frames: 50           # Maximum frames per MP4 (same as GIF for fair comparison)
    max_persons: 10          # Generate MP4s for top 10 persons
    frame_width: 256         # Fixed frame width (maintains aspect ratio)
    frame_height: 384        # Fixed frame height
  
  output:
    videos_dir: ${outputs_dir}/${current_video}/videos
